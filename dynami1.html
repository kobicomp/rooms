<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <title>מערכת הזמנת חדר דינאמיקלאס</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        :root {
            --empty-cell: #e8f5e9;
            --booked-cell: #ffebee;
            --pending-cell: #fff3e0;
            --primary-color: #2196F3;
            --success-color: #4CAF50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            direction: rtl;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .room-info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .room-info h2 {
            margin: 0;
            color: var(--primary-color);
        }

        .room-info p {
            margin: 10px 0 0 0;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
        }

        button:hover {
            opacity: 0.9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: var(--primary-color);
            color: white;
        }

        .cell-empty {
            background-color: var(--empty-cell);
            cursor: pointer;
        }

        .cell-booked {
            background-color: var(--booked-cell);
        }

        .cell-pending {
            background-color: var(--pending-cell);
        }

        .booking-form {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .error {
            color: var(--danger-color);
            margin-top: 5px;
        }

        .info {
            color: var(--primary-color);
            margin-top: 5px;
        }

        .status-indicator {
            padding: 5px 10px;
            border-radius: 4px;
            margin-top: 10px;
            text-align: center;
        }

        .status-pending {
            background-color: var(--warning-color);
            color: white;
        }

        .status-confirmed {
            background-color: var(--success-color);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="room-info">
            <h2>חדר דינאמיקלאס</h2>
            <p>חדר מחשבים חדשני ומתקדם המיועד ללמידה פעילה ושיתופית</p>
            <p>מתאים ל: עד 36 תלמידים, מצויד ב: מקרן, לוח חכם, 6 שולחנות עגולים</p>
        </div>

        <div class="controls">
            <div class="week-nav">
                <button onclick="scheduler.changeWeek(-1)">◀ שבוע קודם</button>
                <span id="current-week"></span>
                <button onclick="scheduler.changeWeek(1)">שבוע הבא ▶</button>
            </div>
        </div>

        <table id="schedule">
            <thead>
                <tr>
                    <th>שעה</th>
                    <th>ראשון</th>
                    <th>שני</th>
                    <th>שלישי</th>
                    <th>רביעי</th>
                    <th>חמישי</th>
                    <th>שישי</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="booking-form" id="booking-form">
        <h3>הזמנת חדר</h3>
        <form id="reservation-form">
            <div class="form-group">
                <label for="teacher">שם המורה:</label>
                <select id="teacher" required></select>
                <div id="teacher-status" class="info"></div>
            </div>
            <div class="form-group">
                <label for="class">כיתה:</label>
                <select id="class" required></select>
                <div id="class-status" class="info"></div>
            </div>
            <div class="form-group">
                <label for="subject">מקצוע:</label>
                <input type="text" id="subject" required>
            </div>
            <input type="hidden" id="selected-date">
            <input type="hidden" id="selected-hour">
            <div id="error-message" class="error"></div>
            <div id="status-message" class="info"></div>
            <div class="form-group">
                <button type="submit">שמור הזמנה</button>
                <button type="button" onclick="scheduler.closeForm()">ביטול</button>
            </div>
        </form>
    </div>

    <script>
        const CONFIG = {
            systemName: "חדר דינאמיקלאס",
            systemDescription: "חדר מחשבים חדשני ומתקדם המיועד ללמידה פעילה ושיתופית",
            systemDetails: "מתאים ל: עד 36 תלמידים, מצויד ב: מקרן, לוח חכם, 6 שולחנות עגולים",

            daysSchedule: {
                0: { name: 'ראשון', lessons: 7 },
                1: { name: 'שני', lessons: 7 },
                2: { name: 'שלישי', lessons: 5 },
                3: { name: 'רביעי', lessons: 7 },
                4: { name: 'חמישי', lessons: 7 },
                5: { name: 'שישי', lessons: 4 }
            },

            urls: {
                schedule: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR5uPK7t_NLTPGlZR4sU0owKAwoygzxa_924tiZH3dHDEEl-f72zjw1ra1AxObkbpMpLURv61Rv4a8M/pub?output=csv',
          teachers: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQUvRHe90lOs14oPNfL3uRqN73uEgmg7L_ON2gXnCD-CuZ_FmTZDRb-rxmmZmeq4frFxh-IMcGLEfy-/pub?output=csv',
          classes: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT1t6xbHD1i8uWUFQb5MmaHbjjyOLhcCdxs26f0nIABkNoGULEia-mfdsS78KlLNeZdtJ31XQEdi70C/pub?gid=0&single=true&output=csv',
          form: 'https://docs.google.com/forms/d/e/1FAIpQLSeOFAZPcacD0pPV6ffQW4Eg5FpMvLqyTHjz3RZ1i5KMJeGrkQ/formResponse'
            },

            formFields: {
                teacher: "entry.1323321977",
                class: "entry.1450687623",
                date: "entry.1431651377",
                hour: "entry.1887686014",
                subject: "entry.1869424962"
            },

            maxWeeklyBookings: 4,
            maxWeeksAhead: 4,
            tempBookingTimeout: 5,
            autoRefreshInterval: 60,
            statusCheckInterval: 10, // seconds
            maxStatusCheckAttempts: 10
        };

        const scheduler = {
            currentWeek: moment(),
            scheduleData: [],
            teachersList: [],
            classesList: [],
            activeStatusChecks: new Map(),

            tempBookingsManager: {
                STORAGE_KEY: 'tempBookings_dynamiclass',

                getData() {
                    try {
                        const stored = localStorage.getItem(this.STORAGE_KEY);
                        return stored ? JSON.parse(stored) : {};
                    } catch {
                        return {};
                    }
                },

                setData(bookings) {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(bookings));
                },

                addBooking(booking) {
                    const bookings = this.getData();
                    const key = `${booking.תאריך}_${booking['שעה במערכת']}`;
                    bookings[key] = {
                        ...booking,
                        expiryTime: Date.now() + (CONFIG.tempBookingTimeout * 60 * 1000)
                    };
                    this.setData(bookings);
                },

                removeBooking(key) {
                    const bookings = this.getData();
                    if (bookings[key]) {
                        delete bookings[key];
                        this.setData(bookings);
                    }
                },

                getValidBookings() {
                    const bookings = this.getData();
                    const now = Date.now();
                    const validBookings = {};
                    Object.entries(bookings).forEach(([key, booking]) => {
                        if (booking.expiryTime > now) {
                            validBookings[key] = booking;
                        }
                    });
                    this.setData(validBookings);
                    return validBookings;
                }
            },

            async loadData(isInitial = false) {
                try {
                    if (isInitial) {
                        await Promise.all([
                            this.loadTeachers(),
                            this.loadClasses()
                        ]);
                    }
                    await this.loadSchedule();
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            },

            async loadSchedule() {
                const response = await fetch(`${CONFIG.urls.schedule}?t=${Date.now()}`, {
                    cache: 'no-store'
                });
                const csvText = await response.text();
                this.scheduleData = this.parseCSV(csvText);
                this.renderSchedule();
            },

            async loadTeachers() {
                const response = await fetch(CONFIG.urls.teachers);
                const csvText = await response.text();
                this.teachersList = this.parseList(csvText);
                this.populateSelect('teacher', this.teachersList);
            },

            async loadClasses() {
                const response = await fetch(CONFIG.urls.classes);
                const csvText = await response.text();
                this.classesList = this.parseList(csvText);
                this.populateSelect('class', this.classesList);
            },

            async checkBookingStatus(booking) {
                try {
                    const response = await fetch(`${CONFIG.urls.schedule}?t=${Date.now()}`, {
                        cache: 'no-store'
                    });
                    const csvText = await response.text();
                    const bookings = this.parseCSV(csvText);
                    
                    return bookings.some(b => 
                        b.תאריך === booking.תאריך && 
                        b['שעה במערכת'] === booking['שעה במערכת'] &&
                        b['שם המורה'] === booking['שם המורה'] &&
                        b['כיתה'] === booking['כיתה']
                    );
                } catch (error) {
                    console.error('Error checking booking status:', error);
                    return false;
                }
            },

            startStatusCheck(booking) {
                const key = `${booking.תאריך}_${booking['שעה במערכת']}`;
                let attempts = 0;

                const checkInterval = setInterval(async () => {
                    attempts++;
                    const isConfirmed = await this.checkBookingStatus(booking);
                    
                    if (isConfirmed) {
                        clearInterval(checkInterval);
                        this.tempBookingsManager.removeBooking(key);
                        this.activeStatusChecks.delete(key);
                        this.renderSchedule();
                        alert('ההזמנה אושרה בהצלחה!');
                    } else if (attempts >= CONFIG.maxStatusCheckAttempts) {
                        clearInterval(checkInterval);
                        this.activeStatusChecks.delete(key);
                        alert('ההזמנה עדיין בהמתנה לאישור. נא לבדוק שוב מאוחר יותר.');
                    }
                }, CONFIG.statusCheckInterval * 1000);

                this.activeStatusChecks.set(key, checkInterval);
            },

            async handleSubmit(event) {
                event.preventDefault();

                const formData = {
                    'שם המורה': document.getElementById('teacher').value,
                    'כיתה': document.getElementById('class').value,
                    'תאריך': document.getElementById('selected-date').value,
                    'שעה במערכת': document.getElementById('selected-hour').value,
                    'מקצוע': document.getElementById('subject').value
                };

                try {
                    await this.loadSchedule();
                    if (this.getBookingForSlot(formData['תאריך'], parseInt(formData['שעה
