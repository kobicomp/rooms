<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת השאלת מחשבים</title>
    
    <!-- React and ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Rubik', system-ui, -apple-system, sans-serif;
            background-color: #f5f7fa;
            overflow-x: hidden;
        }
        
        .rtl {
            direction: rtl;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            border-radius: 15px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.25);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #6366f1, #8b5cf6, #d946ef);
        }

        .gradient-text {
            background: linear-gradient(135deg, #6366f1, #8b5cf6, #d946ef);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hover-scale {
            transition: all 0.3s ease;
        }
        
        .hover-scale:hover {
            transform: scale(1.02);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease-out;
        }

        .computer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }

        .computer-card {
            padding: 1rem;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .form-input {
            @apply p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent 
                   transition-all shadow-sm hover:shadow-md w-full;
        }

        .tabs-container {
            @apply flex flex-wrap gap-2 bg-gradient-to-r from-blue-500 to-purple-600 p-3 rounded-t-lg shadow-lg sticky top-0 z-10;
        }

        .tab-button {
            @apply px-4 py-2 rounded-lg transition-all text-sm sm:text-base font-medium;
        }

        .tab-button.active {
            @apply bg-white text-blue-600 shadow-lg transform scale-105;
        }

        .tab-button:not(.active) {
            @apply bg-transparent text-white hover:bg-white/20;
        }

        .refresh-button {
            @apply fixed bottom-4 right-4 bg-blue-500 text-white p-3 rounded-full shadow-lg 
                   hover:bg-blue-600 transition-all hover:scale-110 z-20
                   flex items-center justify-center;
        }

        .refresh-button.spinning i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .tab-content-header {
            @apply text-2xl font-bold mb-6 text-center gradient-text 
                   border-b pb-4 flex items-center justify-center;
        }

        /* Mobile Responsive */
        @media (max-width: 640px) {
            .computer-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 10px;
                max-height: 85vh;
            }

            .tabs-container {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        // מבנה נתונים למחשב
        class Computer {
            constructor(name) {
                this.name = name;
                this.isBorrowed = false;
                this.borrowedBy = null;
                this.class = null;
                this.lastUpdate = null;
            }
        }

        const { useState, useEffect, useCallback } = React;

        // קומפוננטת לשונית עם כותרות משופרות
        const Tabs = ({ activeTab, setActiveTab }) => {
            return (
                <div className="tabs-container">
                    <button
                        onClick={() => setActiveTab('form')}
                        className={`tab-button ${activeTab === 'form' ? 'active' : ''}`}
                    >
                        <i className="fas fa-laptop-medical ml-2"></i>
                        השאלת מחשבים
                    </button>
                    <button
                        onClick={() => setActiveTab('status')}
                        className={`tab-button ${activeTab === 'status' ? 'active' : ''}`}
                    >
                        <i className="fas fa-desktop ml-2"></i>
                        מצב מחשבים
                    </button>
                    <button
                        onClick={() => setActiveTab('history')}
                        className={`tab-button ${activeTab === 'history' ? 'active' : ''}`}
                    >
                        <i className="fas fa-history ml-2"></i>
                        היסטוריה
                    </button>
                </div>
            );
        };

        // כפתור רענון צף
        const FloatingRefreshButton = ({ onClick, isRefreshing }) => (
            <button 
                onClick={onClick}
                disabled={isRefreshing}
                className={`refresh-button ${isRefreshing ? 'spinning' : ''}`}
                title="רענן נתונים"
            >
                <i className="fas fa-sync-alt"></i>
            </button>
        );

        // קומפוננטת כותרת לכל תוכן
        const TabContentHeader = ({ icon, title }) => (
            <h2 className="tab-content-header">
                <i className={`fas ${icon} ml-2`}></i>
                {title}
            </h2>
        );

        // קומפוננטת כרטיס מחשב
        const ComputerCard = ({ computer }) => {
            const cardColor = computer.isBorrowed ? 'bg-red-50' : 'bg-green-50';
            const statusColor = computer.isBorrowed ? 'text-red-600' : 'text-green-600';
            const icon = computer.isBorrowed ? 'fa-user-lock' : 'fa-unlock';

            return (
                <div className={`glass-card ${cardColor} p-4 hover-scale`}>
                    <div className="flex justify-between items-start">
                        <h3 className="text-lg font-bold">{computer.name}</h3>
                        <i className={`fas ${icon} ${statusColor}`}></i>
                    </div>
                    <div className="mt-2 space-y-1">
                        <p className={`font-medium ${statusColor}`}>
                            {computer.isBorrowed ? 'מושאל' : 'זמין'}
                        </p>
                        {computer.isBorrowed && (
                            <>
                                <p className="text-sm text-gray-600">
                                    <i className="fas fa-user ml-2"></i>
                                    {computer.borrowedBy}
                                </p>
                                <p className="text-sm text-gray-600">
                                    <i className="fas fa-chalkboard ml-2"></i>
                                    {computer.class}
                                </p>
                            </>
                        )}
                        <p className="text-xs text-gray-500 mt-2">
                            <i className="fas fa-clock ml-1"></i>
                            {computer.lastUpdate ? computer.lastUpdate.toLocaleString() : '-'}
                        </p>
                    </div>
                </div>
            );
        };

        // קומפוננטת מודל היסטוריית מחשבים
        const ComputerHistoryContent = ({ computers }) => {
            const [history, setHistory] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [selectedComputer, setSelectedComputer] = useState('');
            
            const RESPONSES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2olqsYKkQqNvrpNR7i8HBuv36zbu5mrVxeM7J-ZtUC0XTpHlvUu1-Jgk9m8pSvxD1GjwbsvGRpp_9/pub?output=csv';

            const fetchComputerHistory = async (computerName) => {
                try {
                    setIsLoading(true);
                    const response = await fetch(RESPONSES_URL);
                    const text = await response.text();
                    const result = Papa.parse(text, {
                        header: false,
                        skipEmptyLines: true
                    });

                    const computerHistory = result.data
                        .slice(1)
                        .filter(row => row[4]?.trim() === computerName)
                        .map(row => ({
                            date: row[0],
                            user: row[1],
                            action: row[2],
                            class: row[3]
                        }))
                        .sort((a, b) => new Date(b.date) - new Date(a.date));

                    setHistory(computerHistory);
                } catch (error) {
                    console.error('Error fetching history:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => {
                if (selectedComputer) {
                    fetchComputerHistory(selectedComputer);
                }
            }, [selectedComputer]);

            return (
                <div className="p-4 glass-card fade-in">
                    <TabContentHeader icon="fa-history" title="היסטוריית מחשבים" />

                    <select
                        value={selectedComputer}
                        onChange={(e) => setSelectedComputer(e.target.value)}
                        className="form-input mb-4"
                    >
                        <option value="">בחר מחשב</option>
                        {Array.from(computers.values()).map(computer => (
                            <option key={computer.name} value={computer.name}>
                                {computer.name}
                            </option>
                        ))}
                    </select>

                    {isLoading ? (
                        <div className="text-center p-8">
                            <div className="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
                            <div className="mt-4 text-gray-600">טוען היסטוריה...</div>
                        </div>
                    ) : selectedComputer && history ? (
                        <div className="overflow-auto rounded-lg shadow">
                            <table className="w-full">
                                <thead className="bg-gray-100">
                                    <tr>
                                        <th className="p-3 text-right">תאריך</th>
                                        <th className="p-3 text-right">פעולה</th>
                                        <th className="p-3 text-right">משתמש</th>
                                        <th className="p-3 text-right">כיתה</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {history.map((entry, index) => (
                                    {history.map((entry, index) => (
<tr 
  key={index}
  className={`${entry.action === 'השאלה' ? 'bg-red-50' : 'bg-green-50'} hover:bg-opacity-80 transition-colors`}
>
                                            <td className="p-3">{entry.date}</td>
                                            <td className="p-3">
                                                <span className={`
                                                    inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                                    ${entry.action === 'השאלה' ? 
                                                        'bg-red-100 text-red-800' : 
                                                        'bg-green-100 text-green-800'
                                                    }
                                                `}>
                                                    {entry.action}
                                                </span>
                                            </td>
                                            <td className="p-3">
                                                <div className="flex items-center">
                                                    <i className="fas fa-user mr-2 text-gray-400"></i>
                                                    {entry.user}
                                                </div>
                                            </td>
                                            <td className="p-3">
                                                <div className="flex items-center">
                                                    <i className="fas fa-chalkboard mr-2 text-gray-400"></i>
                                                    {entry.class}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    ) : selectedComputer && !history.length ? (
                        <div className="text-center p-8 text-gray-500">
                            <i className="fas fa-info-circle text-4xl mb-4"></i>
                            <p>אין היסטוריה למחשב זה</p>
                        </div>
                    ) : null}
                </div>
            );
        };

        // קומפוננט טופס השאלה
        const BorrowForm = ({
            users,
            classes,
            selectedUser,
            setSelectedUser,
            selectedClass,
            setSelectedClass,
            selectedAction,
            setSelectedAction,
            personalCode,
            setPersonalCode,
            handleSubmit,
            availableComputers,
            selectedComputers,
            setSelectedComputers,
            isSubmitting,
            onSuccess
        }) => (
            <form onSubmit={handleSubmit} className="space-y-6 p-6 glass-card fade-in">
                <TabContentHeader icon="fa-laptop-medical" title="השאלת מחשבים" />
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                <i className="fas fa-user ml-2"></i>
                                שם המשאיל
                            </label>
                            <select
                                value={selectedUser}
                                onChange={(e) => setSelectedUser(e.target.value)}
                                className="form-input"
                                required
                            >
                                <option value="">בחר משאיל</option>
                                {users.map((user, index) => (
                                    <option key={index} value={user.value}>
                                        {user.value}
                                    </option>
                                ))}
                            </select>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                <i className="fas fa-key ml-2"></i>
                                קוד אישי
                            </label>
                            <input
                                type="password"
                                value={personalCode}
                                onChange={(e) => setPersonalCode(e.target.value)}
                                className="form-input"
                                required
                                placeholder="הזן קוד אישי"
                            />
                        </div>
                    </div>

                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                <i className="fas fa-chalkboard ml-2"></i>
                                כיתה
                            </label>
                            <select
                                value={selectedClass}
                                onChange={(e) => setSelectedClass(e.target.value)}
                                className="form-input"
                                required
                            >
                                <option value="">בחר כיתה</option>
                                {classes.map((cls, index) => (
                                    <option key={index} value={cls.value}>
                                        {cls.value}
                                    </option>
                                ))}
                            </select>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                <i className="fas fa-exchange-alt ml-2"></i>
                                פעולה
                            </label>
                            <select
                                value={selectedAction}
                                onChange={(e) => setSelectedAction(e.target.value)}
                                className="form-input"
                                required
                            >
                                <option value="השאלה">השאלה</option>
                                <option value="החזרה">החזרה</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div className="mt-6">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                        <i className="fas fa-laptop ml-2"></i>
                        {selectedAction === 'השאלה' ? 'מחשבים זמינים:' : 'מחשבים להחזרה:'}
                    </label>
                    <div className="border rounded-lg p-4 bg-white shadow-inner min-h-[200px] max-h-[400px] overflow-y-auto">
                        {availableComputers.length === 0 ? (
                            <div className="text-center text-gray-500 p-8">
                                <i className="fas fa-info-circle text-4xl mb-4 text-blue-500"></i>
                                <p>
                                    {selectedAction === 'השאלה' ? 
                                        'אין מחשבים זמינים להשאלה' : 
                                        selectedUser ? 
                                            'אין מחשבים מושאלים למשתמש זה' :
                                            'בחר משתמש כדי לראות את המחשבים המושאלים'
                                    }
                                </p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {availableComputers.map((computer, index) => (
                                    <div 
                                        key={index}
                                        className={`
                                            p-3 rounded-lg border cursor-pointer transition-all
                                            ${selectedComputers.includes(computer.name) ? 
                                                'border-blue-500 bg-blue-50' : 
                                                'border-gray-200 hover:border-blue-300'
                                            }
                                        `}
                                        onClick={() => {
                                            if (selectedComputers.includes(computer.name)) {
                                                setSelectedComputers(selectedComputers.filter(name => name !== computer.name));
                                            } else {
                                                setSelectedComputers([...selectedComputers, computer.name]);
                                            }
                                        }}
                                    >
                                        <div className="flex items-center">
                                            <input
                                                type="checkbox"
                                                checked={selectedComputers.includes(computer.name)}
                                                onChange={() => {}}
                                                className="w-4 h-4 ml-3 text-blue-600 rounded"
                                            />
                                            <span className="text-sm font-medium">{computer.name}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    {selectedComputers.length > 0 && (
                        <div className="mt-2 text-sm text-blue-600 flex items-center">
                            <i className="fas fa-check-circle ml-2"></i>
                            נבחרו {selectedComputers.length} מחשבים
                        </div>
                    )}
                </div>

                <button 
                    type="submit" 
                    disabled={selectedComputers.length === 0 || isSubmitting}
                    className={`
                        w-full mt-6 relative py-3 px-6 rounded-lg text-white font-medium 
                        transition-all shadow-lg hover:shadow-xl
                        ${selectedComputers.length === 0 || isSubmitting ?
                            'bg-gray-400 cursor-not-allowed' :
                            'gradient-bg hover:-translate-y-1'
                        }
                    `}
                >
                    {isSubmitting ? (
                        <div className="flex items-center justify-center">
                            <div className="animate-spin h-5 w-5 border-2 border-white rounded-full border-t-transparent ml-3"></div>
                            מעבד את הבקשה...
                        </div>
                    ) : (
                        <div className="flex items-center justify-center">
                            <i className="fas fa-paper-plane ml-2"></i>
                            שלח טופס
                        </div>
                    )}
                </button>
            </form>
        );
        // הקומפוננטה הראשית עם עדכונים אוטומטיים
        const ComputerLendingSystem = () => {
            const [users, setUsers] = useState([]);
            const [classes, setClasses] = useState([]);
            const [computers, setComputers] = useState(new Map());
            const [selectedUser, setSelectedUser] = useState('');
            const [selectedClass, setSelectedClass] = useState('');
            const [selectedAction, setSelectedAction] = useState('השאלה');
            const [selectedComputers, setSelectedComputers] = useState([]);
            const [personalCode, setPersonalCode] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [lastRefresh, setLastRefresh] = useState(null);
            const [activeTab, setActiveTab] = useState('form');
            const [isRefreshing, setIsRefreshing] = useState(false);

            const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdRc_KO4IuEEQpqcl9ed1XpY0hU4gaTYBNLuw3ns5Kx6m2fVw/formResponse';
            const RESPONSES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2olqsYKkQqNvrpNR7i8HBuv36zbu5mrVxeM7J-ZtUC0XTpHlvUu1-Jgk9m8pSvxD1GjwbsvGRpp_9/pub?output=csv';
            const USERS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQUvRHe90lOs14oPNfL3uRqN73uEgmg7L_ON2gXnCD-CuZ_FmTZDRb-rxmmZmeq4frFxh-IMcGLEfy-/pub?output=csv';
            const CLASSES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT1t6xbHD1i8uWUFQb5MmaHbjjyOLhcCdxs26f0nIABkNoGULEia-mfdsS78KlLNeZdtJ31XQEdi70C/pub?output=csv';

            // עדכון אוטומטי כל 30 שניות
            useEffect(() => {
                const interval = setInterval(() => {
                    if (!isSubmitting) {
                        refreshData();
                    }
                }, 30000);
                return () => clearInterval(interval);
            }, [isSubmitting]);

            // פונקציית אימות קוד אישי
            const validatePersonalCode = () => {
                const selectedUserData = users.find(user => user.value === selectedUser);
                return selectedUserData && selectedUserData.code === personalCode;
            };

            // רענון נתונים
            const refreshData = async () => {
                try {
                    setIsRefreshing(true);
                    const computersMap = await analyzeSheetData(RESPONSES_URL);
                    setComputers(computersMap);
                    setLastRefresh(new Date());

                    // עדכון בחירת מחשבים במקרה שמחשב כבר לא זמין
                    const availableComps = Array.from(computersMap.values()).filter(computer => {
                        if (selectedAction === 'השאלה') {
                            return !computer.isBorrowed;
                        } else {
                            return computer.isBorrowed && computer.borrowedBy === selectedUser;
                        }
                    }).map(computer => computer.name);

                    setSelectedComputers(prev => prev.filter(computerName => availableComps.includes(computerName)));
                } catch (error) {
                    console.error('Error refreshing data:', error);
                    setError('אירעה שגיאה בטעינת נתוני המחשבים');
                } finally {
                    setIsRefreshing(false);
                }
            };

            // טעינת נתונים ראשונית
            useEffect(() => {
                const loadAllData = async () => {
                    try {
                        setIsLoading(true);
                        setError(null);

                        const [usersData, classesData] = await Promise.all([
                            loadCSVData(USERS_URL),
                            loadCSVData(CLASSES_URL)
                        ]);

                        setUsers(usersData);
                        setClasses(classesData);
                        await refreshData();
                    } catch (error) {
                        setError('אירעה שגיאה בטעינת הנתונים');
                    } finally {
                        setIsLoading(false);
                    }
                };

                loadAllData();
            }, []);

            // קבלת מחשבים זמינים
            const getAvailableComputers = useCallback(() => {
                const computersList = Array.from(computers.values());
                if (selectedAction === 'השאלה') {
                    return computersList.filter(computer => !computer.isBorrowed);
                } else {
                    return computersList.filter(computer => 
                        computer.isBorrowed && computer.borrowedBy === selectedUser
                    );
                }
            }, [computers, selectedAction, selectedUser]);

            // איפוס בחירות בשינוי משתמש או פעולה
            useEffect(() => {
                setSelectedComputers([]);
                setPersonalCode('');
            }, [selectedUser, selectedAction]);

            // טיפול בשליחת טופס
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (isSubmitting || selectedComputers.length === 0) return;

                if (!validatePersonalCode()) {
                    alert('קוד אישי שגוי');
                    return;
                }

                try {
                    setIsSubmitting(true);

                    // עדכון מיידי של המצב המקומי
                    const updatedComputers = new Map(computers);
                    selectedComputers.forEach(computerName => {
                        const computer = updatedComputers.get(computerName);
                        if (computer) {
                            if (selectedAction === 'השאלה') {
                                computer.isBorrowed = true;
                                computer.borrowedBy = selectedUser;
                                computer.class = selectedClass;
                            } else {
                                computer.isBorrowed = false;
                                computer.borrowedBy = null;
                                computer.class = null;
                            }
                            computer.lastUpdate = new Date();
                        }
                    });
                    setComputers(updatedComputers);

                    // שליחת הטפסים
                    for (const computerName of selectedComputers) {
                        const form = new FormData();
                        form.append('entry.1927360815', selectedUser);
                        form.append('entry.1595080383', selectedAction);
                        form.append('entry.93664657', selectedClass);
                        form.append('entry.973123435', computerName);

                        await fetch(FORM_URL, {
                            method: 'POST',
                            body: form,
                            mode: 'no-cors'
                        });

                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }

                    // איפוס טופס
                    setSelectedComputers([]);
                    setPersonalCode('');

                    // הודעת הצלחה
                    const successMessage = document.createElement('div');
                    successMessage.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50 slide-in';
                    successMessage.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-check-circle ml-2"></i>
                            הפעולה הושלמה בהצלחה!
                        </div>
                    `;
                    document.body.appendChild(successMessage);
                    setTimeout(() => {
                        successMessage.classList.add('fade-out');
                        setTimeout(() => successMessage.remove(), 300);
                    }, 3000);

                    // רענון נתונים אחרי השליחה
                    await refreshData();
                } catch (error) {
                    console.error('Error submitting form:', error);
                    alert('אירעה שגיאה בשליחת הטופס');
                } finally {
                    setIsSubmitting(false);
                }
            };

            if (isLoading) {
                return (
                    <div className="flex justify-center items-center h-screen">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
                            <div className="mt-4 text-gray-600">טוען נתונים...</div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="flex justify-center items-center h-screen">
                        <div className="text-center bg-white p-8 rounded-lg shadow-lg">
                            <div className="text-red-500 text-5xl mb-4">
                                <i className="fas fa-exclamation-circle"></i>
                            </div>
                            <div className="text-red-600 mb-4">{error}</div>
                            <button 
                                onClick={() => window.location.reload()}
                                className="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors"
                            >
                                <i className="fas fa-redo ml-2"></i>
                                נסה שוב
                            </button>
                        </div>
                    </div>
                );
            }

            const availableComputers = getAvailableComputers();

            const renderContent = () => {
                switch (activeTab) {
                    case 'form':
                        return (
                            <BorrowForm 
                                users={users}
                                classes={classes}
                                selectedUser={selectedUser}
                                setSelectedUser={setSelectedUser}
                                selectedClass={selectedClass}
                                setSelectedClass={setSelectedClass}
                                selectedAction={selectedAction}
                                setSelectedAction={setSelectedAction}
                                personalCode={personalCode}
                                setPersonalCode={setPersonalCode}
                                handleSubmit={handleSubmit}
                                availableComputers={availableComputers}
                                selectedComputers={selectedComputers}
                                setSelectedComputers={setSelectedComputers}
                                isSubmitting={isSubmitting}
                            />
                        );
                    case 'status':
                        return (
                            <div className="glass-card p-6 fade-in">
                                <TabContentHeader icon="fa-desktop" title="מצב מחשבים" />
                                <div className="computer-grid">
                                    {Array.from(computers.values()).map((computer) => (
                                        <ComputerCard key={computer.name} computer={computer} />
                                    ))}
                                </div>
                            </div>
                        );
                    case 'history':
                        return <ComputerHistoryContent computers={computers} />;
                    default:
                        return null;
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 py-8 px-4 sm:px-6 lg:px-8">
                    <div className="max-w-6xl mx-auto">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold mb-2 gradient-text">
                                מערכת השאלת מחשבים
                            </h1>
                            {lastRefresh && (
                                <div className="text-sm text-gray-500">
                                    <i className="fas fa-sync ml-1"></i>
                                    עודכן לאחרונה: {lastRefresh.toLocaleTimeString()}
                                </div>
                            )}
                        </div>

                        <Tabs activeTab={activeTab} setActiveTab={setActiveTab} />
                        
                        <div className="mt-6">
                            {renderContent()}
                        </div>

                        <FloatingRefreshButton 
                            onClick={refreshData} 
                            isRefreshing={isRefreshing} 
                        />
                    </div>
                </div>
            );
        };

        // Utility functions
        const loadCSVData = async (url) => {
            try {
                const response = await fetch(url);
                const text = await response.text();
                
                const result = Papa.parse(text, {
                    header: false,
                    skipEmptyLines: true
                });

                return result.data
                    .filter(row => row[0])
                    .map(row => ({
                        value: row[0].trim(),
                        code: row[1]?.trim()
                    }));
            } catch (error) {
                console.error('Error loading CSV:', error);
                throw error;
            }
        };

        const analyzeSheetData = async (sheetUrl) => {
            try {
                const response = await fetch(sheetUrl);
                if (!response.ok) throw new Error('Failed to load sheet data');
                const text = await response.text();

                const result = Papa.parse(text, {
                    header: false,
                    skipEmptyLines: true
                });

                const computers = new Map();

                // טעינת רשימת המחשבים
                const computersResponse = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQei6STuL-DPohSAnmCu8zgljKa4a2r8j4PfZYtrDUL1iV4eCc_eg-1R8VCwfKx-TYC5gS8uqQtE1B9/pub?output=csv');
                const computersText = await computersResponse.text();
                const computersResult = Papa.parse(computersText, {
                    header: false,
                    skipEmptyLines: true
                });

                computersResult.data.forEach(row => {
                    if (row[0]) {
                        const computer = new Computer(row[0].trim());
                        computers.set(computer.name, computer);
                    }
                });

                const rows = result.data.slice(1);
                for (let i = rows.length - 1; i >= 0; i--) {
                    const row = rows[i];
                    const computerName = row[4]?.trim();

                    if (!computerName) continue;

                    const computer = computers.get(computerName);
                    if (computer && (!computer.lastUpdate || new Date(row[0]) > computer.lastUpdate)) {
                        const action = row[2]?.trim();
                        computer.isBorrowed = action === 'השאלה';
                        if (computer.isBorrowed){
                            computer.borrowedBy = row[1]?.trim();
                            computer.class = row[3]?.trim();
                        } else {
                            computer.borrowedBy = null;
                            computer.class = null;
                        }
                        computer.lastUpdate = new Date(row[0]);
                    }
                }

                return computers;
            } catch (error) {
                console.error('Error analyzing sheet:', error);
                throw error;
            }
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ComputerLendingSystem />);
    </script>
</body>
</html>
