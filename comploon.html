<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת השאלת מחשבים</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
        }
        .rtl {
            direction: rtl;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        class Computer {
            constructor(name) {
                this.name = name;
                this.isBorrowed = false;
                this.borrowedBy = null;
                this.class = null;
                this.lastUpdate = null;
            }
        }

        const { useState, useEffect, useCallback, useRef } = React;

        const analyzeSheetData = async (sheetUrl) => {
            try {
                const COMPUTERS_LIST_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQei6STuL-DPohSAnmCu8zgljKa4a2r8j4PfZYtrDUL1iV4eCc_eg-1R8VCwfKx-TYC5gS8uqQtE1B9/pub?output=csv';

                // Use fetch with current timestamp as cache buster
                const response = await fetch(sheetUrl, {
                    cache: 'no-store'
                });

                if (!response.ok) throw new Error('Failed to load sheet data');
                const text = await response.text();

                const result = Papa.parse(text, {
                    header: false,
                    skipEmptyLines: true
                });

                const computers = new Map();

                const computersResponse = await fetch(COMPUTERS_LIST_URL);
                const computersText = await computersResponse.text();
                const computersResult = Papa.parse(computersText, {
                    header: false,
                    skipEmptyLines: true
                });

                computersResult.data.forEach(row => {
                    if (row[0]) {
                        const computerName = row[0].trim();
                        const computer = new Computer(computerName);
                        computers.set(computerName, computer);
                    }
                });

                const rows = result.data.slice(1);
                for (let i = rows.length - 1; i >= 0; i--) {
                    const row = rows[i];
                    if (!row || row.length < 5) continue;

                    const computerName = row[4]?.trim();
                    if (!computerName) continue;

                    const computer = computers.get(computerName);
                    if (!computer) continue;

                    if (!computer.lastUpdate || new Date(row[0]) > computer.lastUpdate) {
                        const action = row[2]?.trim();

                        computer.isBorrowed = action === 'השאלה';
                        if (computer.isBorrowed) {
                            computer.borrowedBy = row[1]?.trim();
                            computer.class = row[3]?.trim();
                        } else {
                            computer.borrowedBy = null;
                            computer.class = null;
                        }
                        computer.lastUpdate = new Date(row[0]);
                    }
                }

                return computers;
            } catch (error) {
                console.error('Error analyzing sheet:', error);
                throw error;
            }
        };

        const ComputerLendingSystem = () => {
            const [computers, setComputers] = useState(new Map());
            const [selectedComputer, setSelectedComputer] = useState(null);
            const [computerHistory, setComputerHistory] = useState([]);
            const [lastRefresh, setLastRefresh] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            const RESPONSES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2olqsYKkQqNvrpNR7i8HBuv36zbu5mrVxeM7J-ZtUC0XTpHlvUu1-Jgk9m8pSvxD1GjwbsvGRpp_9/pub?output=csv';

            const refreshComputersStatus = useCallback(async () => {
                try {
                    const computersMap = await analyzeSheetData(RESPONSES_URL);
                    setComputers(computersMap);
                    setLastRefresh(new Date());
                } catch (error) {
                    setError('אירעה שגיאה בטעינת נתוני המחשבים');
                }
            }, []);

            useEffect(() => {
                const loadInitialData = async () => {
                    try {
                        setIsLoading(true);
                        await refreshComputersStatus();
                    } catch (error) {
                        setError('אירעה שגיאה בטעינת הנתונים');
                    } finally {
                        setIsLoading(false);
                    }
                };

                loadInitialData();
            }, [refreshComputersStatus]);

            const showComputerHistory = async (computerName) => {
                try {
                    const response = await fetch(RESPONSES_URL);
                    const text = await response.text();
                    const result = Papa.parse(text, {
                        header: false,
                        skipEmptyLines: true
                    });

                    const history = result.data
                        .slice(1)
                        .filter(row => row[4]?.trim() === computerName)
                        .map(row => ({
                            date: new Date(row[0]).toLocaleString(),
                            action: row[2]?.trim(),
                            user: row[1]?.trim(),
                            class: row[3]?.trim()
                        }));

                    setSelectedComputer(computerName);
                    setComputerHistory(history);
                } catch (error) {
                    console.error('Error fetching computer history:', error);
                }
            };

            if (isLoading) {
                return (
                    <div className="flex justify-center items-center h-screen">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                    </div>
                );
            }

            return (
                <div className="container mx-auto p-4">
                    <div className="flex justify-between items-center mb-4">
                        <button 
                            onClick={refreshComputersStatus} 
                            className="bg-blue-500 text-white px-4 py-2 rounded"
                        >
                            רענן נתונים
                        </button>
                        {lastRefresh && (
                            <div>עודכן לאחרונה: {lastRefresh.toLocaleTimeString()}</div>
                        )}
                    </div>

                    <div className="grid grid-cols-3 gap-4">
                        {Array.from(computers.values()).map(computer => (
                            <div 
                                key={computer.name} 
                                className={`p-4 rounded ${computer.isBorrowed ? 'bg-red-200' : 'bg-green-200'}`}
                            >
                                <div>שם: {computer.name}</div>
                                <div>סטטוס: {computer.isBorrowed ? 'מושאל' : 'זמין'}</div>
                                {computer.isBorrowed && (
                                    <>
                                        <div>מושאל ל: {computer.borrowedBy}</div>
                                        <div>כיתה: {computer.class}</div>
                                    </>
                                )}
                                <button 
                                    onClick={() => showComputerHistory(computer.name)}
                                    className="mt-2 bg-blue-500 text-white px-2 py-1 rounded"
                                >
                                    היסטוריה
                                </button>
                            </div>
                        ))}
                    </div>

                    {selectedComputer && (
                        <div className="mt-8 bg-white p-4 rounded shadow">
                            <h2 className="text-xl font-bold mb-4">היסטוריית {selectedComputer}</h2>
                            <table className="w-full">
                                <thead>
                                    <tr className="bg-gray-200">
                                        <th>תאריך</th>
                                        <th>פעולה</th>
                                        <th>משתמש</th>
                                        <th>כיתה</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {computerHistory.map((entry, index) => (
                                        <tr key={index} className="text-center">
                                            <td>{entry.date}</td>
                                            <td>{entry.action}</td>
                                            <td>{entry.user}</td>
                                            <td>{entry.class}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ComputerLendingSystem />);
    </script>
</body>
</html>
