<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>מערכת השאלת מחשבים</title>

   <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
   <script src="https://cdn.tailwindcss.com"></script>

   <style>
       body {
           font-family: system-ui, -apple-system, sans-serif;
           direction: rtl;
           background-color: #f0f4f8;
       }
       .card {
           background-color: white;
           border-radius: 12px;
           box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
           transition: transform 0.3s ease;
       }
       .card:hover {
           transform: translateY(-5px);
       }
       .btn-primary {
           background-color: #3b82f6;
           transition: background-color 0.3s ease, transform 0.2s;
       }
       .btn-primary:hover {
           background-color: #2563eb;
           transform: scale(1.02);
       }
   </style>
</head>
<body class="bg-gray-50">
   <div id="root"></div>

   <script type="text/babel">
       // מבנה נתונים למחשב
       class Computer {
           constructor(name) {
               this.name = name;
               this.isBorrowed = false;
               this.borrowedBy = null;
               this.class = null;
               this.lastUpdate = null;
           }
       }

       const { useState, useEffect, useCallback, useRef } = React;

       // טעינה וניתוח נתוני מחשבים
       const analyzeSheetData = async (sheetUrl) => {
           try {
               // הגדרת כתובות גוגל שיטס
               const COMPUTERS_LIST_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQei6STuL-DPohSAnmCu8zgljKa4a2r8j4PfZYtrDUL1iV4eCc_eg-1R8VCwfKx-TYC5gS8uqQtE1B9/pub?output=csv';

               // טעינת הנתונים מהגיליון
               const response = await fetch(`${sheetUrl}${sheetUrl.includes('?') ? '&' : '?'}_=${new Date().getTime()}`);
               if (!response.ok) throw new Error('Failed to load sheet data');
               const text = await response.text();

               // ניתוח הטקסט עם PapaParse
               const result = Papa.parse(text, {
                   header: false,
                   skipEmptyLines: true
               });

               // יצירת מפת מחשבים
               const computers = new Map();

               // טעינת רשימת המחשבים המקורית
               const computersResponse = await fetch(COMPUTERS_LIST_URL);
               const computersText = await computersResponse.text();
               const computersResult = Papa.parse(computersText, {
                   header: false,
                   skipEmptyLines: true
               });

               // יצירת מופעי מחשב
               computersResult.data.forEach(row => {
                   if (row[0]) {
                       const computerName = row[0].trim();
                       const computer = new Computer(computerName);
                       computers.set(computerName, computer);
                   }
               });

               // טיפול בשורות
               const rows = result.data.slice(1);

               // מעבר על השורות מהסוף להתחלה
               for (let i = rows.length - 1; i >= 0; i--) {
                   const row = rows[i];

                   // בדיקת אורך השורה
                   if (!row || row.length < 5) continue;

                   // שם המחשב מעמודה E
                   const computerName = row[4]?.trim();

                   // בדיקת קיום שם המחשב
                   if (!computerName) continue;

                   // בדיקה אם המחשב קיים במערכת
                   const computer = computers.get(computerName);
                   if (!computer) continue;

                   // עדכון רק אם זו השורה העדכנית ביותר עבור המחשב הזה
                   if (!computer.lastUpdate || new Date(row[0]) > computer.lastUpdate) {
                       const action = row[2]?.trim();

                       computer.isBorrowed = action === 'השאלה';
                       if (computer.isBorrowed) {
                           computer.borrowedBy = row[1]?.trim();
                           computer.class = row[3]?.trim();
                       } else {
                           computer.borrowedBy = null;
                           computer.class = null;
                       }
                       computer.lastUpdate = new Date(row[0]);
                   }
               }

               return computers;

           } catch (error) {
               console.error('Error analyzing sheet:', error);
               throw error;
           }
       };

       // טעינת נתונים מקובץ CSV
       const loadCSVData = async (url) => {
           const response = await fetch(url);
           const text = await response.text();
           const result = Papa.parse(text, {
               header: false,
               skipEmptyLines: true
           });
           return result.data
               .filter(row => row[0])
               .map(row => ({
                   value: row[0].trim()
               }));
       };

       const ComputerLendingSystem = () => {
           const [users, setUsers] = useState([]);
           const [classes, setClasses] = useState([]);
           const [computers, setComputers] = useState(new Map());
           const [selectedUser, setSelectedUser] = useState('');
           const [selectedClass, setSelectedClass] = useState('');
           const [selectedAction, setSelectedAction] = useState('השאלה');
           const [selectedComputers, setSelectedComputers] = useState([]);
           const [isLoading, setIsLoading] = useState(true);
           const [error, setError] = useState(null);
           const [submitting, setSubmitting] = useState(false);
           const [lastRefresh, setLastRefresh] = useState(null);
           const [hasChanges, setHasChanges] = useState(false);
           const [showComputerStatus, setShowComputerStatus] = useState(false);

           // היסטוריה חדשים
           const [showHistory, setShowHistory] = useState(false);
           const [selectedHistoryComputer, setSelectedHistoryComputer] = useState('');
           const [computerHistory, setComputerHistory] = useState([]);

           const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdRc_KO4IuEEQpqcl9ed1XpY0hU4gaTYBNLuw3ns5Kx6m2fVw/formResponse';
           const RESPONSES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2olqsYKkQqNvrpNR7i8HBuv36zbu5mrVxeM7J-ZtUC0XTpHlvUu1-Jgk9m8pSvxD1GjwbsvGRpp_9/pub?output=csv';
           const USERS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQUvRHe90lOs14oPNfL3uRqN73uEgmg7L_ON2gXnCD-CuZ_FmTZDRb-rxmmZmeq4frFxh-IMcGLEfy-/pub?output=csv';
           const CLASSES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT1t6xbHD1i8uWUFQb5MmaHbjjyOLhcCdxs26f0nIABkNoGULEia-mfdsS78KlLNeZdtJ31XQEdi70C/pub?output=csv';

           // פונקציה לשליפת היסטוריית מחשב
           const fetchComputerHistory = async (computerName) => {
               try {
                   const response = await fetch(RESPONSES_URL);
                   const text = await response.text();
                   const result = Papa.parse(text, {
                       header: false,
                       skipEmptyLines: true
                   });

                   const history = result.data
                       .slice(1)
                       .filter(row => row[4]?.trim() === computerName)
                       .map(row => ({
                           date: row[0]?.trim(),
                           action: row[2]?.trim(),
                           user: row[1]?.trim(),
                           class: row[3]?.trim()
                       }))
                       .reverse(); // הצג מהחדש לישן

                   setComputerHistory(history);
               } catch (error) {
                   console.error('Error fetching computer history:', error);
               }
           };

           // רענון סטטוס המחשבים
              const refreshComputersStatus = useCallback(async () => {
                  try {
                      const computersMap = await analyzeSheetData(RESPONSES_URL);
                      setComputers(computersMap);
                      setLastRefresh(new Date());
                  } catch (error) {
                      setError('אירעה שגיאה בטעינת נתוני המחשבים');
                  }
              }, []);
   
              // טעינת נתונים ראשונית
              useEffect(() => {
                  const loadAllData = async () => {
                      try {
                          setIsLoading(true);
                          setError(null);
   
                          const [usersData, classesData] = await Promise.all([
                              loadCSVData(USERS_URL),
                              loadCSVData(CLASSES_URL)
                          ]);
   
                          setUsers(usersData);
                          setClasses(classesData);
   
                          await refreshComputersStatus();
                      } catch (error) {
                          setError('אירעה שגיאה בטעינת הנתונים');
                      } finally {
                          setIsLoading(false);
                      }
                  };
   
                  loadAllData();
              }, [refreshComputersStatus]);
   
              // קבלת מחשבים זמינים
              const getAvailableComputers = useCallback(() => {
                  const computersList = Array.from(computers.values());
   
                  if (selectedAction === 'השאלה') {
                      return computersList.filter(computer => !computer.isBorrowed);
                  } else {
                      return computersList.filter(computer =>
                          computer.isBorrowed && computer.borrowedBy === selectedUser
                      );
                  }
              }, [computers, selectedAction, selectedUser]);
   
              // שליחת טופס
              const handleSubmit = async (e) => {
                  e.preventDefault();
                  if (submitting || selectedComputers.length === 0) return;
   
                  try {
                      setSubmitting(true);
   
                      // שליחת טופס לכל מחשב
                      for (const computerName of selectedComputers) {
                          const form = new FormData();
                          form.append('entry.1927360815', selectedUser);
                          form.append('entry.1595080383', selectedAction);
                          form.append('entry.93664657', selectedClass);
                          form.append('entry.973123435', computerName);
   
                          await fetch(FORM_URL, {
                              method: 'POST',
                              body: form,
                              mode: 'no-cors'
                          });
   
                          await new Promise(resolve => setTimeout(resolve, 1000));
                      }
   
                      await new Promise(resolve => setTimeout(resolve, 5000));
                      await refreshComputersStatus();
   
                      setSelectedComputers([]);
                      setHasChanges(false);
                      alert('הפעולה הושלמה בהצלחה!');
                  } catch (error) {
                      alert('אירעה שגיאה בשליחת הטופס');
                  } finally {
                      setSubmitting(false);
                  }
              };
   
              // מודל סטטוס מחשבים
              const ComputerStatusModal = () => (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                      <div className="card w-full max-w-4xl max-h-[90vh] overflow-auto">
                          <div className="flex justify-between items-center mb-4 p-4">
                              <h2 className="text-2xl font-bold">סטטוס מחשבים</h2>
                              <button
                                  onClick={() => setShowComputerStatus(false)}
                                  className="text-red-500 hover:text-red-700"
                              >
                                  סגור
                              </button>
                          </div>
                          <table className="w-full">
                              <thead>
                                  <tr className="bg-gray-200">
                                      <th className="p-2">שם מחשב</th>
                                      <th className="p-2">סטטוס</th>
                                      <th className="p-2">מושאל ל</th>
                                      <th className="p-2">כיתה</th>
                                      <th className="p-2">עדכון אחרון</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  {Array.from(computers.values()).map(computer => (
                                      <tr
                                          key={computer.name}
                                          className={computer.isBorrowed ? "bg-red-100" : "bg-green-100"}
                                      >
                                          <td className="p-2 text-center">{computer.name}</td>
                                          <td className="p-2 text-center">
                                              {computer.isBorrowed ? 'מושאל' : 'זמין'}
                                          </td>
                                          <td className="p-2 text-center">{computer.borrowedBy || '-'}</td>
                                          <td className="p-2 text-center">{computer.class || '-'}</td>
                                          <td className="p-2 text-center">
                                              {computer.lastUpdate ? computer.lastUpdate.toLocaleString() : '-'}
                                          </td>
                                      </tr>
                                  ))}
                              </tbody>
                          </table>
                      </div>
                  </div>
              );
   
              // מודל היסטוריה
              const HistoryModal = () => (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                      <div className="card w-full max-w-4xl max-h-[90vh] overflow-auto">
                          <div className="flex justify-between items-center mb-4 p-4">
                              <h2 className="text-2xl font-bold">היסטוריית מחשבים</h2>
                              <button 
                                  onClick={() => {
                                      setShowHistory(false);
                                      setSelectedHistoryComputer('');
                                      setComputerHistory([]);
                                  }}
                                  className="text-red-500 hover:text-red-700"
                              >
                                  סגור
                              </button>
                          </div>
   
                          <div className="mb-4 px-4">
                              <select
                                  value={selectedHistoryComputer}
                                  onChange={(e) => {
                                      const computerName = e.target.value;
                                      setSelectedHistoryComputer(computerName);
                                      if (computerName) {
                                          fetchComputerHistory(computerName);
                                      }
                                  }}
                                  className="w-full p-2 border rounded"
                              >
                                  <option value="">בחר מחשב</option>
                                  {Array.from(computers.values()).map(computer => (
                                      <option key={computer.name} value={computer.name}>
                                          {computer.name}
                                      </option>
                                  ))}
                              </select>
                          </div>
   
                          {selectedHistoryComputer && computerHistory.length > 0 && (
                              <div className="overflow-auto max-h-[50vh] px-4">
                                  <table className="w-full border-collapse">
                                      <thead>
                                          <tr className="bg-gray-200">
                                              <th className="p-2 border">תאריך</th>
                                              <th className="p-2 border">פעולה</th>
                                              <th className="p-2 border">משתמש</th>
                                              <th className="p-2 border">כיתה</th>
                                          </tr>
                                      </thead>
                                      <tbody>
                                          {computerHistory.map((entry, index) => (
                                              <tr key={index} className="text-center">
                                                  <td className="p-2 border">{entry.date}</td>
                                                  <td className="p-2 border">{entry.action}</td>
                                                  <td className="p-2 border">{entry.user}</td>
                                                  <td className="p-2 border">{entry.class}</td>
                                              </tr>
                                          ))}
                                      </tbody>
                                  </table>
                              </div>
                          )}
                      </div>
                  </div>
              );
   
              // הצגת מצב טעינה
              if (isLoading) {
                  return (
                      <div className="flex justify-center items-center h-screen">
                          <div className="text-center">
                              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                              <div>טוען נתונים...</div>
                          </div>
                      </div>
                  );
              }
   
              // הצגת שגיאה
              if (error) {
                  return (
                      <div className="text-center p-4">
                          <div className="text-red-500 mb-4">{error}</div>
                          <button
                              onClick={() => window.location.reload()}
                              className="bg-blue-500 text-white px-4 py-2 rounded"
                          >
                              נסה שוב
                          </button>
                      </div>
                  );
              }
   
              const availableComputers = getAvailableComputers();
   
              return (
                  <div className="container mx-auto px-4 py-6 max-w-7xl">
                      {showComputerStatus && <ComputerStatusModal />}
                      {showHistory && <HistoryModal />}
   
                      <h1 className="text-2xl sm:text-3xl font-bold mb-6 text-center text-gray-800">מערכת השאלת מחשבים</h1>
   
                      <div className="flex flex-col sm:flex-row gap-2 justify-between items-center mb-4">
                          {lastRefresh && (
                              <div className="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full">
                                  עודכן לאחרונה: {lastRefresh.toLocaleTimeString()}
                              </div>
                          )}
                          <div className="flex flex-wrap gap-2 w-full sm:w-auto">
                              <button
                                  onClick={refreshComputersStatus}
                                  className="btn-primary flex-1 sm:flex-none text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all"
                              >
                                  רענן נתונים
                              </button>
                              <button
                                  onClick={() => setShowComputerStatus(true)}
                                  className="btn-primary flex-1 sm:flex-none text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all"
                              >
                                  סטטוס מחשבים
                              </button>
                              <button
                                  onClick={() => setShowHistory(true)}
                                  className="btn-primary flex-1 sm:flex-none text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-all"
                              >
                                  היסטוריה
                              </button>
                          </div>
                      </div>
   
                      <form 
                          onSubmit={handleSubmit} 
                          onChange={() => setHasChanges(true)} 
                          className="card w-full max-w-md mx-auto space-y-4 p-6 sm:p-8"
                      >
                          <div className="space-y-4">
                              <div className="flex flex-col">
                                  <label className="mb-2 font-medium text-gray-700">שם המשאיל:</label>
                                  <select
                                      value={selectedUser}
                                      onChange={(e) => setSelectedUser(e.target.value)}
                                      className="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                      required
                                  >
                                      <option value="">בחר משאיל</option>
                                      {users.map((user, index) => (
                                          <option key={index} value={user.value}>
                                              {user.value}
                                          </option>
                                      ))}
                                  </select>
                              </div>
   
                              <div className="flex flex-col">
                                  <label className="mb-2 font-medium text-gray-700">כיתה:</label>
                                  <select
                                      value={selectedClass}
                                      onChange={(e) => setSelectedClass(e.target.value)}
                                      className="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                      required
                                  >
                                      <option value="">בחר כיתה</option>
                                      {classes.map((cls, index) => (
                                          <option key={index} value={cls.value}>
                                              {cls.value}
                                          </option>
                                      ))}
                                  </select>
                              </div>
   
                              <div className="flex flex-col">
                                  <label className="mb-2 font-medium text-gray-700">פעולה:</label>
                                  <select
                                      value={selectedAction}
                                      onChange={(e) => setSelectedAction(e.target.value)}
                                      className="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                      required
                                  >
                                      <option value="השאלה">השאלה</option>
                                      <option value="החזרה">החזרה</option>
                                  </select>
                              </div>
   
                              <div className="flex flex-col">
                                  <label className="mb-2 font-medium text-gray-700">
                                      {selectedAction === 'השאלה' ? 'מחשבים זמינים:' : 'מחשבים להחזרה:'}
                                  </label>
                                  <div className="space-y-2 border rounded p-4 max-h-48 overflow-y-auto">
                                      {availableComputers.length === 0 ? (
                                          <div className="text-center text-gray-500">
                                              {selectedAction === 'השאלה' ?
                                                  'אין מחשבים זמינים להשאלה' :
                                                  selectedUser ?
                                                      'אין מחשבים מושאלים למשתמש זה' :
                                                      'בחר משתמש כדי לראות את המחשבים המושאלים'
                                              }
                                          </div>
                                      ) : (
                                          availableComputers.map((computer, index) => (
                                              <div key={index} className="flex items-center justify-end">
                                                  <label className="flex items-center space-x-2 cursor-pointer">
                                                      <input
                                                          type="checkbox"
                                                          checked={selectedComputers.includes(computer.name)}
                                                          onChange={(e) => {
                                                              if (e.target.checked) {
                                                                  setSelectedComputers([...selectedComputers, computer.name]);
                                                              } else {
                                                              selectedComputers.filter(name => name !== computer.name)
                                                          );
                                                      }
                                                      setHasChanges(true);
                                                  }}
                                                  className="w-4 h-4 ml-2"
                                              />
                                              <span>{computer.name}</span>
                                          </label>
                                      </div>
                                  ))}
                              </div>
                              {selectedComputers.length > 0 && (
                                  <div className="mt-2 text-sm text-gray-600">
                                      נבחרו {selectedComputers.length} מחשבים
                                  </div>
                              )}
                          </div>

                          <button
                              type="submit"
                              className="w-full btn-primary text-white py-3 rounded-lg hover:bg-blue-700 transition-all disabled:opacity-50"
                              disabled={selectedComputers.length === 0 || submitting}
                          >
                              {submitting ? (
                                  <div className="flex items-center justify-center">
                                      <span className="mr-2">מעבד את הבקשה...</span>
                                      <div className="animate-spin h-5 w-5 border-2 border-white rounded-full border-t-transparent"></div>
                                  </div>
                              ) : (
                                  'שלח טופס'
                              )}
                          </button>

                          {submitting && (
                              <div className="text-sm text-gray-500 text-center mt-2">
                                  הנתונים מתעדכנים, אנא המתן...
                              </div>
                          )}
                      </div>
                  </form>
              </div>
          );
      };

      // Render the app
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<ComputerLendingSystem />);
  </script>
</body>
</html>
